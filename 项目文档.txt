# 政府资料AI分析助手

## 项目概述

基于 OpenCode Agent Skill 的政策文档分析系统，为华测导航提供政策文档自动化分析能力。

## 设计思路

### 核心架构

```
┌─────────────────────────────────────────────────────────────┐
│                      Flask Web 服务                          │
│  (端口 5000，访问 http://localhost:5000)                      │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                    OpenCode 客户端                           │
│  - 会话管理 (create/delete/validate)                         │
│  - 消息发送 (send_message)                                   │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                   OpenCode Agent                             │
│  - policy-document-analyzer skill                           │
│  - 自动读取 skill 定义和政策文档                             │
│  - 按四步流程分析并保存结果                                  │
└─────────────────────────────────────────────────────────────┘
```

### 定时任务流程

```
启动 Flask
    │
    ▼
同步执行政策文档分析 (5个文档，每个独立session)
    │
    ▼
启动定时调度器 (每30天自动执行)
    │
    ▼
Flask 开始接收用户请求
```

### 文件结构

```
AI Skill分析/
├── app.py              # Flask 主应用
├── opencode_client.py  # OpenCode API 客户端
├── analyzer.py         # 政策文档分析器
├── scheduler.py        # 定时任务调度器
├── policy_document/    # 政策文档目录
│   ├── document_1.md
│   ├── document_2.md
│   └── 上海市/
│       └── document_1.md
├── analyze_result/     # 分析结果输出目录
│   ├── document_1_分析结果.md
│   └── 上海市/
│       └── document_1_分析结果.md
├── templates/
│   └── index.html      # 前端页面
├── static/
│   ├── css/style.css   # 样式文件
│   └── js/main.js      # 前端逻辑
└── .claude/
    └── skills/
        └── policy-document-analyzer/
            └── SKILL.md  # Agent Skill 定义
```

## 部署逻辑

### 1. 启动顺序

```bash
# 1. 先启动 OpenCode 服务
opencode serve

# 2. 启动 Flask 应用 (会自动先执行政策文档分析)
python app.py
```

### 2. 启动时行为

1. **同步执行政策文档分析**
   - 扫描 `policy_document/` 目录
   - 为每个文档创建独立 session
   - 发送 prompt 让 OpenCode 使用 skill 分析
   - 等待所有分析完成（不设置超时）
   - 完成后保存状态到 `analyze_status.json`

2. **启动定时任务**
   - 每 30 天自动执行一次分析
   - 使用 BackgroundScheduler

3. **启动 Flask 服务**
   - 端口: 5000
   - 监听所有地址 (0.0.0.0)

### 3. API 接口

| 接口 | 方法 | 说明 |
|------|------|------|
| `/` | GET | 主页面 |
| `/health` | GET | 健康检查/连接状态 |
| `/ask` | POST | 发送消息给 AI |
| `/api/documents` | GET | 政策文档列表 |
| `/api/analysis-results` | GET | 分析结果列表 |
| `/api/analyze-status` | GET | 自动分析状态 |
| `/api/trigger-analyze` | POST | 手动触发分析 |

### 4. 环境要求

```bash
# Python 依赖
pip install flask apscheduler python-dotenv requests
```

## Web 端设计

### 界面布局

```
┌─────────────────────────────────────────────────────────────┐
│  [Logo] 政策文档分析助手                    [新建对话]       │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  ┌─────────────────┐  ┌─────────────────────────────────┐  │
│  │                 │  │                                 │  │
│  │   侧边栏        │  │                                 │  │
│  │                 │  │         主内容区                │  │
│  │  - 历史记录     │  │                                 │  │
│  │  - 政策文档     │  │     (聊天/文档/分析结果)        │  │
│  │  - 分析结果     │  │                                 │  │
│  │                 │  │                                 │  │
│  └─────────────────┘  └─────────────────────────────────┘  │
│                                                             │
├─────────────────────────────────────────────────────────────┤
│  [已连接]                              [已自动分析成功] [▶] │
└─────────────────────────────────────────────────────────────┘
```

### 功能区域

1. **左侧菜单栏**
   - 新建对话按钮
   - 历史记录列表
   - 政策文档管理
   - 分析结果查看
   - 底部状态栏（连接状态 + 自动分析状态 + 手动触发按钮）

2. **主内容区**
   - 聊天视图（对话区域）
   - 文档管理视图（文件列表）
   - 分析结果视图（结果列表）

3. **快捷指令**
   - 分析政策文档
   - 提取相关段落
   - 生成引用格式
   - 查看分析结果

### 状态显示

| 状态 | 显示内容 |
|------|----------|
| 未分析 | 等待自动分析 ⏳ |
| 分析成功 | 已自动分析成功 ✅ |
| 分析失败 | 已自动分析失败 ❌ |

### 手动触发

- 状态栏右侧有播放按钮
- 点击可手动触发政策文档分析
- 分析过程中显示加载状态

## Skill 定义

### policy-document-analyzer

**位置**: `.claude/skills/policy-document-analyzer/SKILL.md`

**能力**:
- 读取并分析政策文档
- 评估与华测导航八大产业应用的相关度（精准农业、测绘导航、智能制造等）
- 摘取相关段落
- 生成标准化引用格式

**输出**:
- 保存到 `analyze_result/` 目录
- 文件命名: `{原始文件名}_分析结果.md`
- 保持原始目录结构

## 注意事项

1. **OpenCode 服务性能**
   - 分析每个文档可能需要较长时间
   - 建议在分析完成后使用聊天功能
   - 不要设置请求超时

2. **Session 管理**
   - 定时分析使用独立 session
   - 聊天共用一个 session
   - 不要删除正在处理的 session

3. **文件路径**
   - 政策文档放在 `policy_document/` 目录
   - 分析结果输出到 `analyze_result/` 目录
   - 支持子目录结构
